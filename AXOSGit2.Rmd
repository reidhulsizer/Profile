---
title: "R Notebook"
output: html_notebook
---

---
title: "AccessReportScript"
output: html_document
---





```{r}
setwd("X:/Office of the CEO/Project/Personnel Reporting & Tracking/Building Access Reports/Data Files-Monthly Access/QuarterDataHub")
car = read.csv2("Car2.csv", skip = 8,  header = T, sep = ",",  fill = TRUE)
card = read.csv2("Card2.csv",  header = T, sep = ",")
vpn =  read.csv2("VPN2.csv",  header = T, sep = ",")
library(RODBC)
dbhandle <- odbcDriverConnect('driver={SQL Server};server=XXXXXXXXX;database=DWSupport;trusted_connection=true')
AD = sqlQuery(dbhandle, 'select * from AD.InfoSnapshot')
ADP = sqlQuery(dbhandle, 'select * from dbo.vwADP_INFO')
empinfo = merge(AD ,ADP, by.x = "extensionAttribute1", by.y = "Emp Number")
dbh <- odbcDriverConnect('driver={SQL Server};server=XXXXXXX;database=BusinessVault;trusted_connection=true')
ManagerH = sqlQuery(dbh, 'select * from SLF.vw_EmployeeManagerHierarchy')
```



#Run Next Chunk if no Data Problems


```{r}
colnames(vpn) = c("date.time..UTC.","message","user_name")
vpn = subset(vpn, as.character(vpn$message) == "connection established")
username = as.data.frame(cbind(empinfo$extensionAttribute1, as.character(empinfo$SAMAccountName)))
colnames(username) = c("EID", "user_name")
vpn$user_name = tolower(vpn$user_name)
username$user_name = tolower(username$user_name)
vpn = merge(vpn, username, by = "user_name")
car$FullName = paste(car$Last.Name,  car$X.3)
car = car[!(as.character(car$Card.Direction) == ""),]
Names = as.data.frame(rbind(cbind(empinfo$extensionAttribute1, as.character(empinfo$Name)), cbind(ADP$`Emp Number`, paste(ADP$`First Name`, ADP$`Last Name`))))
colnames(Names) = c("EID", "Name")
Names = unique(Names)
setwd("X:/Office of the CEO/Project/Personnel Reporting & Tracking/Building Access Reports/Data Files-Monthly Access/QuarterDataHub")
HistoricalNameFix = read.csv2("HistoricalNameFix.csv", header = T, sep = ",",  fill = TRUE)
Names = as.data.frame(rbind(Names, HistoricalNameFix))
car$Location = c("San Diego")
card$Location = sub(" .*", "", trimws(sub("-.*", "", card$Description..1)))
card$Location[card$Location == 'SAN'] = "San Diego"
card$Location[card$Location == 'SD'] = "San Diego"
card$Location[card$Location == 'KANSAS'] = "Kansas"
card$Location[card$Location == 'UTAH'] = "Utah"
card$Location[card$Location == 'LAS'] = "Las Vegas"
card$Location[card$Location == 'Laguna'] = "Laguna Hills"
card$Location[card$Location == 'Axos'] = "Los Angeles"
library(dplyr)
log1 = cbind.data.frame(car$FullName, car$Location, as.POSIXct(as.character(car$Card.Direction), format="%m/%d/%Y  %H:%M")) 
log2 = cbind.data.frame(card$Description..2, card$Location, as.POSIXct(as.character(card$Date.and.Time), format = "%m/%d/%Y %I:%M:%S %p"))
colnames(log1) = c("Name", "Location", "DateTime")
colnames(log2) = c("Name", "Location", "DateTime")
log2$DateTime = if_else(is.na(log2$DateTime), as.POSIXct(as.character(card$Date.and.Time), format = "%m/%d/%Y %H:%M"), log2$DateTime)
log = rbind.data.frame(log1,log2)
temp = merge(log, Names, by = "Name", all.x = T)
temp$DateTime = NULL
temp$Location = NULL
ManualNameFix = unique(subset(temp, is.na(temp$EID)))
NameReference1 = as.data.frame(cbind(as.character(ADP$`First Name`), as.character(ADP$`Last Name`), ADP$`Emp Number`))
NameReference2 = as.data.frame(cbind(empinfo$extensionAttribute1, as.character(empinfo$Name)))
colnames(NameReference1) = c("First Name", "Last Name", "EmployeeID")
colnames(NameReference2) = c("EmployeeID", "Name")
library(data.table)
setwd("X:/Office of the CEO/Project/Personnel Reporting & Tracking/Building Access Reports/Data Files-Monthly Access/QuarterDataHub/ManualNameFix")
fwrite(NameReference1, "NameReference1.csv")
fwrite(NameReference2, "NameReference2.csv")
fwrite(ManualNameFix, "ManualNameFix.csv")
```
#Go To ManualNameFix.csv file (folder below) and update the EID field for the correspondent name with the appropriate Employee ID. Lookups can be done with the two name reference files. If no Employee ID can be determined, leave the EID cell bank. When all lookups have been completed, save the file and run the code chunk below

##  X:\Office of the CEO\Project\Personnel Reporting & Tracking\Building Access Reports\Data Files\QuarterDataHub\ManualNameFix

```{r}
setwd("X:/Office of the CEO/Project/Personnel Reporting & Tracking/Building Access Reports/Data Files-Monthly Access/QuarterDataHub/ManualNameFix")
ManualNameFix = read.csv2("ManualNameFix.csv", header = T, sep = ",",  fill = TRUE)
HistoricalNameFix = rbind.data.frame(HistoricalNameFix, subset(ManualNameFix, ManualNameFix$EID != ""))
library(data.table)
setwd("X:/Office of the CEO/Project/Personnel Reporting & Tracking/Building Access Reports/Data Files-Monthly Access/QuarterDataHub")
fwrite(HistoricalNameFix, "HistoricalNameFix.csv")
Names = as.data.frame(rbind(Names, HistoricalNameFix))
Names = unique(Names)
log = merge(Names, log, by ="Name")
log = subset(log, log$EID != "NULL")
log = subset(log, log$EID != "")
log$Date = as.Date(as.POSIXct(log$DateTime), 'America/Los_Angeles')
log$Name = NULL
library(dplyr)
temp = cbind.data.frame(log$EID,log$Location)
colnames(temp) = c("EID", "Location")
MostCommonLocation = temp %>% group_by(EID) %>% slice(which.max(table(Location)) )
tempmin = log %>%
    group_by(EID,Date) %>% 
  slice(which.min(DateTime))
tempmax = log %>%
    group_by(EID,Date) %>% 
  slice(which.max(DateTime))
temp = merge(tempmin,tempmax, by = c("EID" ,"Date"))
colnames(temp)[4] = c("EarliestScan")
colnames(temp)[3] = c("ScanInLocation")
colnames(temp)[6] = c("LatestScan")
colnames(temp)[5] = c("ScanOutLocation")
log = temp
vpn$message_id = NULL
vpn$user_name = NULL
vpn$DateTime = as.POSIXct(as.character(vpn$date.time..UTC.), tz = "UTC",  format = "%Y-%m-%dT%H:%M:%S")
attributes(vpn$DateTime)$tzone = "America/Los_Angeles" 
vpn$Date = as.Date(as.POSIXct(vpn$DateTime), 'America/Los_Angeles')
vpn$date.time..UTC. = NULL
tempmin = vpn %>%
    group_by(EID,Date) %>% 
  slice(which.min(DateTime))
tempmax = vpn %>%
    group_by(EID,Date) %>% 
  slice(which.max(DateTime))
vpn = merge(tempmin,tempmax, by = c("EID" ,"Date"))
colnames(vpn)[4] = c("EarliestVPNScan")
colnames(vpn)[6] = c("LatestVPNScan")
fulldata = merge(log,vpn, by = c("EID" ,"Date"), all = T)
fulldata$VPNBeforeWork = as.numeric(as.POSIXct(fulldata$EarliestScan) > as.POSIXct(fulldata$EarliestVPNScan))
fulldata$VPNAfterWork = as.numeric(as.POSIXct(fulldata$LatestScan) < as.POSIXct(fulldata$LatestVPNScan))
fulldata$VPNNoScan = 0
fulldata$VPNNoScan[is.na(fulldata$EarliestScan)] = 1
fulldata$VPNBeforeWork[is.na(fulldata$VPNBeforeWork)] = 0
fulldata$VPNAfterWork[is.na(fulldata$VPNAfterWork)] = 0
ManagerH$EVP = as.character(ManagerH$EVP)
ManagerH$EmployeeName = as.character(ManagerH$EmployeeName)
ManagerH$EVP[is.na(ManagerH$EVP)] = ManagerH$EmployeeName[is.na(ManagerH$EVP)]
EVP = cbind.data.frame(ManagerH$EmployeeNumber, ManagerH$EVP, ManagerH$EmployeeName )
colnames(EVP) = c("EID", "EVP", "EmployeeName")
fulldata = merge(fulldata, EVP, by = "EID", all.x = T)
fulldata = merge(fulldata, ADP, by.x = "EID", by.y = "Emp Number")
fulldata$HoursWorked = difftime(fulldata$LatestScan,fulldata$EarliestScan, units = "hours")
term = cbind.data.frame( ADP$Status, ADP$`Emp Number`)
colnames(term) = c("Status", "EID")
fulldata = merge(term, fulldata, by = "EID", all.y = T)
fulldata = subset(fulldata, fulldata$Status.x != "Terminated")
fulldata$Status.x = NULL
fulldata = merge(MostCommonLocation, fulldata, by = "EID", all.y = T)
fulldata$Location = as.character(fulldata$Location)
fulldata$Location[is.na(fulldata$Location)] <- c("Remote")
fulldata$message.x = NULL
fulldata$message.y = NULL
fulldata$`Reports To Name` = as.character(fulldata$`Reports To Name`)
fulldata$`Payroll Name` = as.character(fulldata$`Payroll Name`)
fulldata$`Reports To Name`[fulldata$`Reports To Name` == ""] = fulldata$`Payroll`[fulldata$`Reports To Name` == ""]
setwd("X:/Office of the CEO/Project/Personnel Reporting & Tracking/Building Access Reports/Data Files-Monthly Access/QuarterDataHub/EVPReports")
fwrite(mutate(fulldata, EarliestScan = format(EarliestScan, "%H:%M:%S"), LatestScan = format(LatestScan, "%H:%M:%S"), EarliestVPNScan = format(EarliestVPNScan, "%H:%M:%S"), LatestVPNScan = format(LatestVPNScan, "%H:%M:%S")), file="DataMaster.csv", row.names=FALSE)
```
###Filter the Data in the DataMaster file to the appropriate EVP and then paste value the data into the appropriate EVP's Report. Then refresh the report and email out to the EVP.






